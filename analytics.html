<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>FIRE HEXOS</title>
    <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico">
    <script src="https://d3js.org/d3.v4.js"></script>
    <style>
        .bar {
            fill: green;
        }

        svg {
            background-color: gray;
        }

        h2 {
            text-align: center;
        }

        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #333;
            text-align: center;
            align-self: center;
        }

        li {
            float: left;
        }

            li a {
                display: block;
                color: white;
                text-align: center;
                padding: 14px 16px;
                text-decoration: none;
            }

                li a:hover {
                    background-color: #111;
                }
    </style>
</head>
<body>
    <ul>
        <li><a class="active" href=".\index.html">Home</a></li>
        <li><a onclick="ShowCardRatedFavorite()">Favorites</a></li>
    </ul>

    <svg id="d3_demo"></svg>

    <script>
        var importedCards = "";
        var dataDump = "";
        // set the dimensions and margins of the graph
        const width = document.body.clientWidth-20, height = 500;

        const x_scale = d3.scaleBand().range([0, width]).padding(0.1);
        const y_scale = d3.scaleLinear().range([height, 0]);

        LoadFromFirebase();
        function LoadFromFirebase() {
            fetch('https://fire-hexos-default-rtdb.europe-west1.firebasedatabase.app/cards.json')
                .then(response => response.json())
                .then(data => processCards(data));
        }


        function processCards(cards) {
            importedCards = cards;
            var arrayLength = importedCards.length;
            for (var i = 0; i < arrayLength; i++) {
                importedCards[i].effizience = 0;
                importedCards[i].usage = 0;
                importedCards[i].profizience = 0;
            }

            fetch('https://fire-hexos-default-rtdb.europe-west1.firebasedatabase.app/analytics.json')
                .then(response => response.json())
                .then(data => processStats(data));

        }

        function processStats(data) {
            dataDump = data;
            var arrayLength = dataDump.length;
            for (var i = 0; i < arrayLength; i++) {
                var deckLength = dataDump[i].deck.length;
                for (var d = 0; d < deckLength; d++) {
                    var card = importedCards.find(x => x.id === dataDump[i].deck[d]);
                    card.usage++;
                    if (dataDump[i].winner === "WINNER") {
                        card.effizience++;
                    }
                    else if (dataDump[i].winner === "LOSER") {
                        card.effizience--;
                    }
                }
            }

            ShowCardsanalyticalStats();
        }

        function ShowCardsanalyticalStats() {
            const svg = d3.select("#d3_demo").attr("width", width).attr("height", 100 * (importedCards.length + 1));


            var x = d3.scaleLinear()
                .domain([-110, 110])         // This is the min and the max of the data: 0 to 100 if percentages
                .range([0, 1280]);       // This is the corresponding value I want in Pixel

            // Show the axis that corresponds to this scale
            //svg.call(d3.axisBottom(x));

            for (let i = 0; i < importedCards.length; i++) {
                var localCard = importedCards[i];

                if (localCard.effizience != 0) {
                    localCard.profizience = (localCard.effizience / localCard.usage) * 100;
                }
            }

            importedCards.sort((a, b) => Number(b.profizience) - Number(a.profizience));

            for (let i = 0; i < importedCards.length; i++) {
                var localCard = importedCards[i];

                svg.append("rect").attr("x", localCard.profizience <= 0 ? x(localCard.profizience) : x(0)).attr("y", (100 * i) + 110)
                    .attr("width", localCard.profizience <= 0 ? x(0) - x(localCard.profizience) : x(localCard.profizience) - x(0))
                    .attr("height", 20).style("stroke", "yellow").style("fill", "red");

                svg.append("circle").attr("cx", x(0)).attr("cy", (100 * i) + 100).attr("r", 40).style("stroke", "yellow").style("fill", "blue");
                svg.append('image')
                    .attr('xlink:href', localCard.imageUrl)
                    .attr('width', 60)
                    .attr('height', 60)
                    .attr('x', x(-5))
                    .attr('y', (100 * i) + 70);


                svg.append("text")
                    .attr("x", x(7))
                    .attr("y", (100 * i) + 250)
                    .attr("dy", "-5.1em")
                    .attr("text-anchor", "end")
                    .attr("font-size", "22px")
                    .attr("fill", "black")
                    .attr("stroke", "yellow")
                    .text(localCard.name);
            }
        }


        function ShowCardRatedFavorite() {

            document.getElementById('d3_demo').innerHTML = "";
            const svg = d3.select("#d3_demo").attr("width", width).attr("height", 100 * (importedCards.length + 1));

            importedCards.sort((a, b) => Number(b.usage) - Number(a.usage));
            var favoriteCard = importedCards[0];
            var x = d3.scaleLinear()
                .domain([0, favoriteCard.usage + 5])         // This is the min and the max of the data: 0 to 100 if percentages
                .range([0, 1280]);       // This is the corresponding value I want in Pixel

            for (let i = 0; i < importedCards.length; i++) {
                var localCard = importedCards[i];

                svg.append("rect")
                    .attr("x", 100)
                    .attr("y", (100 * i) + 110)
                    .attr("width", x(localCard.usage))
                    .attr("height", 20)
                    .style("stroke", "yellow").style("fill", "red");

                svg.append("circle").attr("cx", 100).attr("cy", (100 * i) + 100).attr("r", 40).style("stroke", "yellow").style("fill", "blue");
                svg.append('image')
                    .attr('xlink:href', localCard.imageUrl)
                    .attr('width', 100)
                    .attr('height', 100)
                    .attr('x', 100)
                    .attr('y', (100 * i) + 40);


                svg.append("text")
                    .attr("x", 350)
                    .attr("y", (100 * i) + 200)
                    .attr("dy", "-5.1em")
                    .attr("text-anchor", "end")
                    .attr("font-size", "22px")
                    .attr("fill", "black")
                    .attr("stroke", "yellow")
                    .text(localCard.name);
            }
        }

    </script>
</body>
</html>